import React, { useEffect, useState } from 'react'
import { supabase } from '../lib/supa'

const headerFont = { fontFamily: 'Montserrat, Inter, system-ui, Arial, sans-serif', textTransform:'uppercase', letterSpacing:'0.08em' }

export default function AssignRepDialog({ open, event, onClose, onAssigned }) {
  const [reps,setReps] = useState([])
  const [repId,setRepId] = useState('')
  const [err,setErr] = useState(null)
  const [saving,setSaving] = useState(false)

  useEffect(()=>{ if(!open) return; (async ()=>{
    const { data, error } = await supabase
      .from('v_brand_reps')
      .select('profile_id,rep_name')
      .eq('brand_id', event?.brand_id)
    if(!error) setReps(data||[])
  })() },[open, event?.brand_id])

  if(!open) return null

  async function assign(e){
    e.preventDefault(); setErr(null); setSaving(true)
    const { error } = await supabase
      .from('events')
      .update({ assigned_rep_id: repId, status: 'assigned' })
      .eq('id', event.id)
    setSaving(false)
    if(error) setErr(error.message); else { onAssigned?.(); onClose() }
  }

  return (
    <div className="modal"><div className="modal-card">
      <h2 style={headerFont}>Assign Brand Rep</h2>
      <form onSubmit={assign} className="grid" style={{gridTemplateColumns:'1fr', gap:12}}>
        <select className="input" required value={repId} onChange={e=>setRepId(e.target.value)}>
          <option value="">Select a rep…</option>
          {reps.map(r => <option key={r.profile_id} value={r.profile_id}>{r.rep_name}</option>)}
        </select>
        {err && <div className="text-danger">{err}</div>}
        <div className="row">
          <button type="button" className="btn outline" onClick={onClose}>Close</button>
          <div style={{flex:1}}/>
          <button className="btn accent" disabled={saving} type="submit">{saving ? 'Assigning…':'Assign'}</button>
        </div>
      </form>
    </div></div>
  )
}
